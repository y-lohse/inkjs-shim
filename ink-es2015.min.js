(function (global, factory) {
	typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :
	typeof define === 'function' && define.amd ? define('inkjs', ['exports'], factory) :
	(factory((global.inkjs = global.inkjs || {})));
}(this, (function (exports) { 'use strict';

	class Path$1{constructor(){this._isRelative,this._components=[],"string"==typeof arguments[0]?this.componentsString=arguments[0]:arguments[0]instanceof Component&&arguments[1]instanceof Path$1?(this._components.push(arguments[0]),this._components=this._components.concat(arguments[1])):arguments[0]instanceof Array&&(this._components=this._components.concat(arguments[0]),this._isRelative=!!arguments[1]);}get isRelative(){return this._isRelative}get components(){return this._components}get head(){return 0<this.components.length?this.components[0]:null}get tail(){if(2<=this.components.length){var a=this.components.slice(1,this.components.length);return new Path$1(a)}return Path$1.self}get length(){return this.components.length}get lastComponent(){return 0<this.components.length?this.components[this.components.length-1]:null}get containsNamedComponent(){for(var a=0,b=this.components.length;a<b;a++)if(!this.components[a].isIndex)return!0;return!1}static get self(){var a=new Path$1;return a._isRelative=!0,a}PathByAppendingPath(a){var b=new Path$1,c=0;for(var d=0;d<a.components.length&&a.components[d].isParent;++d)c++;for(var d=0;d<this.components.length-c;++d)b.components.push(this.components[d]);for(var d=c;d<a.components.length;++d)b.components.push(a.components[d]);return b}get componentsString(){var a=this.components.join(".");return this.isRelative?"."+a:a}set componentsString(a){this.components.length=0;var b=a;if(null!=b&&""!=b){"."==b[0]&&(this._isRelative=!0,b=b.substring(1));var c=b.split(".");c.forEach(d=>{/^(\-|\+)?([0-9]+|Infinity)$/.test(d)?this.components.push(new Component(parseInt(d))):this.components.push(new Component(d));});}}toString(){return this.componentsString}Equals(a){if(null==a)return!1;if(a.components.length!=this.components.length)return!1;if(a.isRelative!=this.isRelative)return!1;for(var b=0,c=a.components.length;b<c;b++)if(!a.components[b].Equals(this.components[b]))return!1;return!0}}class Component{constructor(a){"string"==typeof a?(this._index=-1,this._name=a):(this._index=parseInt(a),this._name=null);}get index(){return this._index}get name(){return this._name}get isIndex(){return 0<=this.index}get isParent(){return this.name==Path$1.parentId}static ToParent(){return new Component(Path$1.parentId)}toString(){return this.isIndex?this.index.toString():this.name}Equals(a){return null!=a&&a.isIndex==this.isIndex&&(this.isIndex?this.index==a.index:this.name==a.name)}}Path$1.parentId="^",Path$1.Component=Component;

	class Object$1{constructor(){this.parent=null,this._path=null;}get path(){if(null==this._path)if(null==this.parent)this._path=new Path$1;else{for(var a=[],b=this,c=b.parent;c instanceof Container;){var d=b;d.name&&d.hasValidName?a.unshift(new Path$1.Component(d.name)):a.unshift(new Path$1.Component(c.content.indexOf(b))),b=c,c=c.parent;}this._path=new Path$1(a);}return this._path}get rootContentContainer(){for(var a=this;a.parent;)a=a.parent;return a}ResolvePath(a){if(a.isRelative){var b=this;return!1==b instanceof Container&&(null==this.parent&&console.warn('Can\'t resolve relative path because we don\'t have a parent'),b=this.parent,'Container'!==b.constructor.name&&console.warn('Expected parent to be a container'),a=a.tail),b.ContentAtPath(a)}return this.rootContentContainer.ContentAtPath(a)}ConvertPathToRelative(a){var b=this.path,c=Math.min(a.components.length,b.components.length),d=-1;for(var e=0;e<c;++e){var f=b.components[e],g=a.components[e];if(f.Equals(g))d=e;else break}if(-1==d)return a;var h=b.components.length-1-d,j=[];for(var k=0;k<h;++k)j.push(Path$1.Component.ToParent());for(var l=d+1;l<a.components.length;++l)j.push(a.components[l]);var m=new Path$1(j,!0);return m}CompactPathString(a){var b=null,c=null;if(a.isRelative)c=a.componentsString,b=this.path.PathByAppendingPath(a).componentsString;else{var d=this.ConvertPathToRelative(a);c=d.componentsString,b=a.componentsString;}return c.Length<b.Length?c:b}Copy(){throw'Not Implemented'}SetChild(a,b,c){a[b]&&(a[b]=null),a[b]=c,a[b]&&(a[b].parent=this);}}

	class StringBuilder{constructor(a){a='undefined'==typeof a?'':a.toString(),this._string=a;}get Length(){return this._string.length}Append(a){this._string+=a;}AppendLine(a){'undefined'!=typeof a&&this.Append(a),this._string+='\n';}AppendFormat(a){var b=Array.prototype.slice.call(arguments,1);return a.replace(/{(\d+)}/g,function(c,d){return'undefined'==typeof b[d]?c:b[d]})}toString(){return this._string}}

	class RawListItem{constructor(c,d){if(d!==void 0)this.originName=c,this.itemName=d;else{var e=c.toString().split('.');this.originName=e[0],this.itemName=e[1];}}static Null(){return new RawListItem(null,null)}isNull(){return null==this.originName&&null==this.itemName}get fullName(){return(null===this.originName?'?':this.originName)+'.'+this.itemName}toString(){return this.fullname}Equals(c){if(c instanceof RawListItem){var d=c;return d.itemName==this.itemName&&d.originName==this.originName}return!1}toString(){var c='0',d=this.itemName?this.itemName.toString():'null';return null!=this.originName&&(c=this.originName.toString()),c+d}}class RawList{constructor(c){if(this._keys={},this._values={},this.origins=null,this._originNames=null,c)if(c instanceof RawList){var d=c;d.forEach(f=>{this.Add(f.Key,f.Value);}),this._originNames=d._originNames;}else if(c.hasOwnProperty('Key')&&c.hasOwnProperty('Value')){var e=c;this.Add(e.Key,e.Value);}}forEach(c){for(var d in this._values)c({Key:this._keys[d],Value:this._values[d]});}ContainsKey(c){return c in this._values}Add(c,d){this._keys[c]=c,this._values[c]=d;}Remove(c){delete this._values[c],delete this._keys[c];}get Count(){return Object.keys(this._values).length}get originOfMaxItem(){if(null==this.origins)return null;var c=this.maxItem.Key.originName,d=null;return this.origins.every(function(e){return e.name!=c||(d=e,!1)}),d}get originNames(){return 0<this.Count&&(null==this._originNames&&0<this.Count?this._originNames=[]:this._originNames.length=0,this.forEach(c=>{this._originNames.push(c.Key.originName);})),this._originNames}SetInitialOriginName(c){this._originNames=[c];}SetInitialOriginNames(c){this._originNames=c.slice();}get maxItem(){var c={Key:null,Value:null};return this.forEach(function(d){(null===c.Key||d.Value>c.Value)&&(c=d);}),c}get minItem(){var c={Key:null,Value:null};return this.forEach(function(d){(null===c.Key||d.Value<c.Value)&&(c=d);}),c}get inverse(){var c=new RawList;return null!=this.origins&&this.origins.forEach(d=>{d.items.forEach(e=>{this.ContainsKey(e.Key)||c.Add(e.Key,e.Value);});}),c}get all(){var c=new RawList;return null!=this.origins&&this.origins.forEach(function(d){d.items.forEach(function(e){c.Add(e.Key,e.Value);});}),c}Union(c){var d=new RawList(this);return c.forEach(function(e){d.Add(e.Key,e.Value);}),d}Intersect(c){var d=new RawList;return this.forEach(function(e){c.ContainsKey(e.Key)&&d.Add(e.Key,e.Value);}),d}Without(c){var d=new RawList(this);return c.forEach(function(e){d.Remove(e.Key);}),d}Contains(c){var d=!0;return c.forEach(e=>{this.ContainsKey(e.Key)||(d=!1);}),d}GreaterThan(c){return 0!=this.Count&&(!(0!=c.Count)||this.minItem.Value>c.maxItem.Value)}GreaterThanOrEquals(c){return 0!=this.Count&&(!(0!=c.Count)||this.minItem.Value>=c.minItem.Value&&this.maxItem.Value>=c.maxItem.Value)}LessThan(c){return 0!=c.Count&&(!(0!=this.Count)||this.maxItem.Value<c.minItem.Value)}LessThanOrEquals(c){return 0!=c.Count&&(!(0!=this.Count)||this.maxItem.Value<=c.maxItem.Value&&this.minItem.Value<=c.minItem.Value)}MaxAsList(){return 0<this.Count?new RawList(this.maxItem):new RawList}MinAsList(){return 0<this.Count?new RawList(this.minItem):new RawList}Equals(c){var d=c;if(!1==d instanceof RawList)return!1;if(d.Count!=this.Count)return!1;var e=!0;return this.forEach(function(f){d.ContainsKey(f.Key)||(e=!1);}),e}toString(){var c=[];this.forEach(function(g){c.push(g);}),c=c.sort((g,h)=>{return g.Value===h.Value?0:g.Value>h.Value?1:-1});var d=new StringBuilder;for(var e=0;e<c.length;e++){0<e&&d.Append(', ');var f=c[e].Key;d.Append(f.itemName);}return d.toString()}valueOf(){return NaN}}

	var ValueType={Int:0,Float:1,List:2,String:3,DivertTarget:4,VariablePointer:5};class AbstractValue extends Object$1{constructor(){super(),this._valueType,this._isTruthy,this._valueObject;}get valueType(){return this._valueType}get isTruthy(){return this._isTruthy}get valueObject(){return this._valueObject}Cast(){throw'Trying to casting an AbstractValue'}static Create(a){if('boolean'==typeof a){var d=!!a;a=d?1:0;}return Number.isInteger(+a)?new IntValue(a):isNaN(a)?'string'==typeof a?new StringValue(a):a instanceof Path$1?new DivertTargetValue(a):a instanceof RawList?new ListValue(a):null:new FloatValue(a)}Copy(a){return AbstractValue.Create(a)}}class Value extends AbstractValue{constructor(a){super(),this.value=a;}get value(){return this._value}set value(a){this._value=a;}get valueObject(){return this.value}toString(){return this.value.toString()}}class IntValue extends Value{constructor(a){super(a||0),this._valueType=ValueType.Int;}get isTruthy(){return 0!=this.value}get valueType(){return ValueType.Int}Cast(a){if(a==this.valueType)return this;if(a==ValueType.Float)return new FloatValue(parseFloat(this.value));if(a==ValueType.String)return new StringValue(''+this.value);throw'Unexpected type cast of Value to new ValueType'}}class FloatValue extends Value{constructor(a){super(a||0),this._valueType=ValueType.Float;}get isTruthy(){return 0!=this._value}get valueType(){return ValueType.Float}Cast(a){if(a==this.valueType)return this;if(a==ValueType.Int)return new IntValue(parseInt(this.value));if(a==ValueType.String)return new StringValue(''+this.value);throw'Unexpected type cast of Value to new ValueType'}}class StringValue extends Value{constructor(a){super(a||''),this._valueType=ValueType.String,this._isNewline='\n'==this.value,this._isInlineWhitespace=!0,this.value.split().every(d=>{return' '!=d&&'\t'!=d?(this._isInlineWhitespace=!1,!1):!0});}get valueType(){return ValueType.String}get isTruthy(){return 0<this.value.length}get isNewline(){return this._isNewline}get isInlineWhitespace(){return this._isInlineWhitespace}get isNonWhitespace(){return!this.isNewline&&!this.isInlineWhitespace}Cast(a){if(a==this.valueType)return this;if(a==ValueType.Int){var d;return(d=parseInt(value))?new IntValue(d):null}if(a==ValueType.Float){var e;return(e=e(value))?new FloatValue(e):null}throw'Unexpected type cast of Value to new ValueType'}}class DivertTargetValue extends Value{constructor(a){super(a),this._valueType=ValueType.DivertTarget;}get targetPath(){return this.value}set targetPath(a){this.value=a;}get isTruthy(){throw'Shouldn\'t be checking the truthiness of a divert target'}Cast(a){if(a==this.valueType)return this;throw'Unexpected type cast of Value to new ValueType'}toString(){return'DivertTargetValue('+this.targetPath+')'}}class VariablePointerValue extends Value{constructor(a,d){super(a),this._valueType=ValueType.VariablePointer,this.contextIndex='undefined'==typeof d?-1:d;}get variableName(){return this.value}set variableName(a){this.value=a;}get isTruthy(){throw'Shouldn\'t be checking the truthiness of a variable pointer'}Cast(a){if(a==this.valueType)return this;throw'Unexpected type cast of Value to new ValueType'}toString(){return'VariablePointerValue('+this.variableName+')'}Copy(){return new VariablePointerValue(this.variableName,this.contextIndex)}}class ListValue extends Value{get valueType(){return ValueType.List}get isTruthy(){var a=!1;return this.value.forEach(function(d){var e=d.Value;0!=e&&(a=!0);}),a}Cast(a){if(a==ValueType.Int){var d=this.value.maxItem;return d.Key.isNull?new IntValue(0):new IntValue(d.Value)}if(a==ValueType.Float){var d=this.value.maxItem;return d.Key.isNull?new FloatValue(0):new FloatValue(parseFloat(d.Value))}if(a==ValueType.String){var d=value.maxItem;return d.Key.isNull?new StringValue(''):new StringValue(d.Key.toString())}if(a==this.valueType)return this;throw'Unexpected type cast of Value to new ValueType'}constructor(a,d){super(null),this._valueType=ValueType.List,this.value=a instanceof RawList?new RawList(a):void 0!==a&&void 0!==d?new RawList({Key:a,Value:d}):new RawList;}static RetainListOriginsForAssignment(a,d){var e=a,f=d;e instanceof ListValue&&f instanceof ListValue&&0==f.value.Count&&f.value.SetInitialOriginNames(e.value.originNames);}}

	class StoryException extends Error{constructor(a){super(a),this.message=a,this.name='StoryException';}}

	class Container extends Object$1{constructor(){super(),this.name='',this._content=[],this.namedContent={},this.visitsShouldBeCounted=!1,this.turnIndexShouldBeCounted=!1,this.countingAtStartOnly=!1,this.CountFlags={Visits:1,Turns:2,CountStartOnly:4},this._pathToFirstLeafContent=null;}get hasValidName(){return null!=this.name&&0<this.name.length}get content(){return this._content}set content(a){this.AddContent(a);}get namedOnlyContent(){var a={};for(var b in this.namedContent)a[b]=this.namedContent[b];return this.content.forEach(d=>{var e=d;e.name&&e.hasValidName&&delete a[e.name];}),0==a.length&&(a=null),a}set namedOnlyContent(a){var b=this.namedOnlyContent;if(null!=b)for(var d in b)delete this.namedContent[d];if(null!=a)for(var d in a){var e=a[d];e.name&&'undefined'!=typeof e.hasValidName&&this.AddToNamedContentOnly(e);}}get countFlags(){var a=0;return this.visitsShouldBeCounted&&(a|=this.CountFlags.Visits),this.turnIndexShouldBeCounted&&(a|=this.CountFlags.Turns),this.countingAtStartOnly&&(a|=this.CountFlags.CountStartOnly),a==this.CountFlags.CountStartOnly&&(a=0),a}set countFlags(a){var b=a;0<(b&this.CountFlags.Visits)&&(this.visitsShouldBeCounted=!0),0<(b&this.CountFlags.Turns)&&(this.turnIndexShouldBeCounted=!0),0<(b&this.CountFlags.CountStartOnly)&&(this.countingAtStartOnly=!0);}get pathToFirstLeafContent(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}get internalPathToFirstLeafContent(){for(var a=new Path,b=this;b instanceof Container;)0<b.content.length&&(a.components.push(new Path.Component(0)),b=b.content[0]);return a}AddContent(a){if(a instanceof Array)a.forEach(b=>{this.AddContent(b);});else{if(this._content.push(a),a.parent)throw'content is already in '+a.parent;a.parent=this,this.TryAddNamedContent(a);}}TryAddNamedContent(a){a.hasValidName&&a.name&&this.AddToNamedContentOnly(a);}AddToNamedContentOnly(a){!1==a instanceof Object$1&&console.warn('Can only add Runtime.Objects to a Runtime.Container'),a.parent=this,this.namedContent[a.name]=a;}ContentAtPath(a,b){b='undefined'==typeof b?a.components.length:b;var d=this,e=this;for(var f=0;f<b;++f){var g=a.components[f];if(!(d instanceof Container))throw'Path continued, but previous object wasn\'t a container: '+e;e=d.ContentWithPathComponent(g),d=e;}return e}InsertContent(a){if(this.content[i]=a,a.parent)throw'content is already in '+a.parent;a.parent=this,this.TryAddNamedContent(a);}AddContentsOfContainer(a){this.content=this.content.concat(a.content),a.content.forEach(b=>{b.parent=this,this.TryAddNamedContent(b);});}ContentWithPathComponent(a){if(a.isIndex)return 0<=a.index&&a.index<this.content.length?this.content[a.index]:null;if(a.isParent)return this.parent;var b=null;if(b=this.namedContent[a.name])return b;throw new StoryException('Content \''+a.name+'\' not found at path: \''+this.path+'\'')}BuildStringOfHierarchy(a,b,d){function e(){for(var l=0;l<4*b;++l)a.Append(' ');}if(0==arguments.length){var a=new StringBuilder;return this.BuildStringOfHierarchy(a,0,null),a.toString()}e(),a.Append('['),this.hasValidName&&a.AppendFormat(' ({0})',this.name),this==d&&a.Append('  <---'),a.AppendLine(),b++;for(var f=0;f<this.content.length;++f){var g=this.content[f];if(g instanceof Container){var h=g;h.BuildStringOfHierarchy(a,b,d);}else e(),g instanceof StringValue?(a.Append('"'),a.Append(g.toString().replace('\n','\\n')),a.Append('"')):a.Append(g.toString());f!=this.content.length-1&&a.Append(','),g instanceof Container||g!=d||a.Append('  <---'),a.AppendLine();}var j={};for(var k in this.namedContent)if(0<=this.content.indexOf(this.namedContent[k]))continue;else j[k]=this.namedContent[k];if(0<Object.keys(j).length)for(var k in e(),a.AppendLine('-- named: --'),j){j[k]instanceof Container||console.warn('Can only print out named Containers');var h=j[k];h.BuildStringOfHierarchy(a,b,d),a.Append('\n');}b--,e(),a.Append(']');}}

	class Glue extends Object$1{constructor(a){super(),this.glueType=a;}get isLeft(){return this.glueType==GlueType.Left}get isBi(){return this.glueType==GlueType.Bidirectional}get isRight(){return this.glueType==GlueType.Right}toString(){switch(this.glueType){case GlueType.Bidirectional:return"BidirGlue";case GlueType.Left:return"LeftGlue";case GlueType.Right:return"RightGlue";}return"UnexpectedGlueType"}}let GlueType={Bidirectional:0,Left:1,Right:2};

	class ControlCommand extends Object$1{constructor(a){super(),this._commandType='undefined'==typeof a?CommandType.NotSet:a;}get commandType(){return this._commandType}copy(){return new ControlCommand(this.commandType)}toString(){return this.commandType.toString()}static EvalStart(){return new ControlCommand(CommandType.EvalStart)}static EvalOutput(){return new ControlCommand(CommandType.EvalOutput)}static EvalEnd(){return new ControlCommand(CommandType.EvalEnd)}static Duplicate(){return new ControlCommand(CommandType.Duplicate)}static PopEvaluatedValue(){return new ControlCommand(CommandType.PopEvaluatedValue)}static PopFunction(){return new ControlCommand(CommandType.PopFunction)}static PopTunnel(){return new ControlCommand(CommandType.PopTunnel)}static BeginString(){return new ControlCommand(CommandType.BeginString)}static EndString(){return new ControlCommand(CommandType.EndString)}static NoOp(){return new ControlCommand(CommandType.NoOp)}static ChoiceCount(){return new ControlCommand(CommandType.ChoiceCount)}static TurnsSince(){return new ControlCommand(CommandType.TurnsSince)}static Random(){return new ControlCommand(CommandType.Random)}static SeedRandom(){return new ControlCommand(CommandType.SeedRandom)}static VisitIndex(){return new ControlCommand(CommandType.VisitIndex)}static SequenceShuffleIndex(){return new ControlCommand(CommandType.SequenceShuffleIndex)}static StartThread(){return new ControlCommand(CommandType.StartThread)}static Done(){return new ControlCommand(CommandType.Done)}static End(){return new ControlCommand(CommandType.End)}static ListFromInt(){return new ControlCommand(CommandType.ListFromInt)}static ListRange(){return new ControlCommand(CommandType.ListRange)}}var CommandType={NotSet:-1,EvalStart:0,EvalOutput:1,EvalEnd:2,Duplicate:3,PopEvaluatedValue:4,PopFunction:5,PopTunnel:6,BeginString:7,EndString:8,NoOp:9,ChoiceCount:10,TurnsSince:11,Random:12,SeedRandom:13,VisitIndex:14,SequenceShuffleIndex:15,StartThread:16,Done:17,End:18,ListFromInt:19,ListRange:20};CommandType.TOTAL_VALUES=Object.keys(CommandType).length-1,ControlCommand.CommandType=CommandType;

	let PushPopType={Tunnel:0,Function:1};

	class Divert extends Object$1{constructor(a){super(),this._targetPath,this._targetContent,this.variableDivertName,this.pushesToStack,this.stackPushType,this.isExternal,this.isConditional,this.externalArgs,this.pushesToStack=!1,a&&(this.pushesToStack=!0,this.stackPushType=a);}get targetPath(){if(null!=this._targetPath&&this._targetPath.isRelative){var a=this.targetContent;a&&(this._targetPath=a.path);}return this._targetPath}set targetPath(a){this._targetPath=a,this._targetContent=null;}get targetContent(){return null==this._targetContent&&(this._targetContent=this.ResolvePath(this._targetPath)),this._targetContent}get targetPathString(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)}set targetPathString(a){this.targetPath=null==a?null:new Path$1(a);}get hasVariableTarget(){return null!=this.variableDivertName}Equals(a){var b=a;return b instanceof Divert&&this.hasVariableTarget==b.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==b.variableDivertName:this.targetPath.Equals(b.targetPath))}toString(){if(this.hasVariableTarget)return'Divert(variable: '+this.variableDivertName+')';if(null==this.targetPath)return'Divert(null)';var a=new StringBuilder,b=this.targetPath.toString(),c=null;return a.Append('Divert'),this.pushesToStack&&(this.stackPushType==PushPopType.Function?a.Append(' function'):a.Append(' tunnel')),a.Append(' ('),a.Append(b),a.Append(')'),a.toString()}}

	class ChoicePoint extends Object$1{constructor(a){super(),this._pathOnChoice,this.hasCondition,this.hasStartContent,this.hasChoiceOnlyContent,this.onceOnly,this.isInvisibleDefault,this.onceOnly=!!a;}get pathOnChoice(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){var a=this.choiceTarget;a&&(this._pathOnChoice=a.path);}return this._pathOnChoice}get choiceTarget(){return this.ResolvePath(this._pathOnChoice)}get pathStringOnChoice(){return this.CompactPathString(this.pathOnChoice)}set pathStringOnChoice(a){this.pathOnChoice=new Path$1(a);}get flags(){var a=0;return this.hasCondition&&(a|=1),this.hasStartContent&&(a|=2),this.hasChoiceOnlyContent&&(a|=4),this.isInvisibleDefault&&(a|=8),this.onceOnly&&(a|=16),a}set flags(a){this.hasCondition=0<(1&a),this.hasStartContent=0<(2&a),this.hasChoiceOnlyContent=0<(4&a),this.isInvisibleDefault=0<(8&a),this.onceOnly=0<(16&a);}set pathOnChoice(a){this._pathOnChoice=a;}toString(){var a=null,b=this.pathOnChoice.toString();return'Choice: -> '+b}}

	class VariableReference extends Object$1{constructor(a){super(),this.name=a,this.pathForCount;}get containerForCount(){return this.ResolvePath(this.pathForCount)}get pathStringForCount(){return null==this.pathForCount?null:this.CompactPathString(this.pathForCount)}set pathStringForCount(a){this.pathForCount=null==a?null:new Path$1(a);}toString(){if(null!=this.name)return'var('+this.name+')';var a=this.pathStringForCount;return'read_count('+a+')'}}

	class VariableAssignment extends Object$1{constructor(a,b){super(),this._variableName=a||null,this._isNewDeclaration=!!b,this.isGlobal;}get variableName(){return this._variableName}get isNewDeclaration(){return this._isNewDeclaration}toString(){return"VarAssign to "+this.variableName}}

	class Void extends Object$1{}

	class NativeFunctionCall extends Object$1{constructor(a){super(),this.name=a,this._numberOfParameters,this._prototype,this._isPrototype,this._operationFuncs=null,NativeFunctionCall.GenerateNativeFunctionsIfNecessary();}get name(){return this._name}set name(a){this._name=a,this._isPrototype||(this._prototype=NativeFunctionCall._nativeFunctions[this._name]);}get numberOfParameters(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters}set numberOfParameters(a){this._numberOfParameters=a;}static internalConstructor(a,b){var c=new NativeFunctionCall(a);return c._isPrototype=!0,c.numberOfParameters=b,c}static CallWithName(a){return new NativeFunctionCall(a)}static CallExistsWithName(a){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions[a]}Call(a){if(this._prototype)return this._prototype.Call(a);if(this.numberOfParameters!=a.length)throw'Unexpected number of parameters';var b=!1;if(a.forEach(e=>{if(e instanceof Void)throw new StoryException('Attempting to perform operation on a void value. Did you forget to \'return\' a value from a function you called here?');e instanceof ListValue&&(b=!0);}),2==a.length&&b)return this.CallBinaryListOperation(a);var c=this.CoerceValuesToSingleType(a),d=c[0].valueType;return d==ValueType.Int?this.CallType(c):d==ValueType.Float?this.CallType(c):d==ValueType.String?this.CallType(c):d==ValueType.DivertTarget?this.CallType(c):d==ValueType.List?this.CallType(c):null}CallType(a){var b=a[0],c=b.valueType,d=b,e=a.length;if(2==e||1==e){var f=this._operationFuncs[c];if(!f)throw new StoryException('Cannot perform operation \''+this.name+'\' on '+c);if(2==e){var g=a[1],h=f,i=h(d.value,g.value);return Value.Create(i)}var h=f,i=h(d.value);return Value.Create(i)}throw'Unexpected number of parameters to NativeFunctionCall: '+a.length}CallBinaryListOperation(a){if(('+'==this.name||'-'==this.name)&&a[0]instanceof ListValue&&a[1]instanceof IntValue)return this.CallListIncrementOperation(a);var b=a[0],c=a[1];if(('&&'==this.name||'||'==this.name)&&(b.valueType!=ValueType.List||c.valueType!=ValueType.List)){var d=this._operationFuncs[ValueType.Int],e=d(b.isTruthy?1:0,c.isTruthy?1:0);return parseInt(e)}if(b.valueType==ValueType.List&&c.valueType==ValueType.List)return this.CallType([b,c]);throw new StoryException('Can not call use \''+this.name+'\' operation on '+b.valueType+' and '+c.valueType)}CallListIncrementOperation(a){var b=a[0],c=a[1],d=new RawList;return b.value.forEach(e=>{var f=e.Key,g=e.Value,h=this._operationFuncs[ValueType.Int],i=h(g,c.value),j=null;if(b.value.origins.forEach(function(l){if(l.name==f.originName)return j=l,!1}),null!=j){var k=j.TryGetItemWithValue(i);k.exists&&d.Add(k.item,i);}}),new ListValue(d)}CoerceValuesToSingleType(a){var b=ValueType.Int,c=null;a.forEach(e=>{var f=e;f.valueType>b&&(b=f.valueType),f.valueType==ValueType.List&&(c=f);});var d=[];return b==ValueType.List?a.forEach(function(e){if(e.valueType==ValueType.List)d.push(e);else if(e.valueType==ValueType.Int){var f=parseInt(e.valueObject),g=c.value.originOfMaxItem,h=g.TryGetItemWithValue(f);if(h.exists){var i=new ListValue(h.item,f);d.push(i);}else throw new StoryException('Could not find List item with the value '+f+' in '+g.name)}else throw new StoryException('Cannot mix Lists and '+e.valueType+' values in this operation')}):a.forEach(function(e){var f=e.Cast(b);d.push(f);}),d}static GenerateNativeFunctionsIfNecessary(){if(null==this._nativeFunctions){this._nativeFunctions={},this.AddIntBinaryOp(this.Add,(b,c)=>{return b+c}),this.AddIntBinaryOp(this.Subtract,(b,c)=>{return b-c}),this.AddIntBinaryOp(this.Multiply,(b,c)=>{return b*c}),this.AddIntBinaryOp(this.Divide,(b,c)=>{return parseInt(b/c)}),this.AddIntBinaryOp(this.Mod,(b,c)=>{return b%c}),this.AddIntUnaryOp(this.Negate,b=>{return-b}),this.AddIntBinaryOp(this.Equal,(b,c)=>{return b==c?1:0}),this.AddIntBinaryOp(this.Greater,(b,c)=>{return b>c?1:0}),this.AddIntBinaryOp(this.Less,(b,c)=>{return b<c?1:0}),this.AddIntBinaryOp(this.GreaterThanOrEquals,(b,c)=>{return b>=c?1:0}),this.AddIntBinaryOp(this.LessThanOrEquals,(b,c)=>{return b<=c?1:0}),this.AddIntBinaryOp(this.NotEquals,(b,c)=>{return b==c?0:1}),this.AddIntUnaryOp(this.Not,b=>{return 0==b?1:0}),this.AddIntBinaryOp(this.And,(b,c)=>{return 0!=b&&0!=c?1:0}),this.AddIntBinaryOp(this.Or,(b,c)=>{return 0!=b||0!=c?1:0}),this.AddIntBinaryOp(this.Max,(b,c)=>{return Math.max(b,c)}),this.AddIntBinaryOp(this.Min,(b,c)=>{return Math.min(b,c)}),this.AddFloatBinaryOp(this.Add,(b,c)=>{return b+c}),this.AddFloatBinaryOp(this.Subtract,(b,c)=>{return b-c}),this.AddFloatBinaryOp(this.Multiply,(b,c)=>{return b*c}),this.AddFloatBinaryOp(this.Divide,(b,c)=>{return b/c}),this.AddFloatBinaryOp(this.Mod,(b,c)=>{return b%c}),this.AddFloatUnaryOp(this.Negate,b=>{return-b}),this.AddFloatBinaryOp(this.Equal,(b,c)=>{return b==c?1:0}),this.AddFloatBinaryOp(this.Greater,(b,c)=>{return b>c?1:0}),this.AddFloatBinaryOp(this.Less,(b,c)=>{return b<c?1:0}),this.AddFloatBinaryOp(this.GreaterThanOrEquals,(b,c)=>{return b>=c?1:0}),this.AddFloatBinaryOp(this.LessThanOrEquals,(b,c)=>{return b<=c?1:0}),this.AddFloatBinaryOp(this.NotEquals,(b,c)=>{return b==c?0:1}),this.AddFloatUnaryOp(this.Not,b=>{return 0==b?1:0}),this.AddFloatBinaryOp(this.And,(b,c)=>{return 0!=b&&0!=c?1:0}),this.AddFloatBinaryOp(this.Or,(b,c)=>{return 0!=b||0!=c?1:0}),this.AddFloatBinaryOp(this.Max,(b,c)=>{return Math.max(b,c)}),this.AddFloatBinaryOp(this.Min,(b,c)=>{return Math.min(b,c)}),this.AddStringBinaryOp(this.Add,(b,c)=>{return b+c}),this.AddStringBinaryOp(this.Equal,(b,c)=>{return b===c?1:0}),this.AddListBinaryOp(this.Add,(b,c)=>{return b.Union(c)}),this.AddListBinaryOp(this.And,(b,c)=>{return b.Union(c)}),this.AddListBinaryOp(this.Subtract,(b,c)=>{return b.Without(c)}),this.AddListBinaryOp(this.Has,(b,c)=>{return b.Contains(c)?1:0}),this.AddListBinaryOp(this.Hasnt,(b,c)=>{return b.Contains(c)?0:1}),this.AddListBinaryOp(this.Intersect,(b,c)=>{return b.Intersect(c)}),this.AddListBinaryOp(this.Equal,(b,c)=>{return b.Equals(c)?1:0}),this.AddListBinaryOp(this.Greater,(b,c)=>{return b.GreaterThan(c)?1:0}),this.AddListBinaryOp(this.Less,(b,c)=>{return b.LessThan(c)?1:0}),this.AddListBinaryOp(this.GreaterThanOrEquals,(b,c)=>{return b.GreaterThanOrEquals(c)?1:0}),this.AddListBinaryOp(this.LessThanOrEquals,(b,c)=>{return b.LessThanOrEquals(c)?1:0}),this.AddListBinaryOp(this.NotEquals,(b,c)=>{return b.Equals(c)?0:1}),this.AddListUnaryOp(this.Not,b=>{return 0==b.Count?1:0}),this.AddListUnaryOp(this.Invert,b=>{return b.inverse}),this.AddListUnaryOp(this.All,b=>{return b.all}),this.AddListUnaryOp(this.ListMin,b=>{return b.MinAsList()}),this.AddListUnaryOp(this.ListMax,b=>{return b.MaxAsList()}),this.AddListUnaryOp(this.Count,b=>{return b.Count}),this.AddListUnaryOp(this.ValueOfList,b=>{return b.maxItem.Value});var a=(b,c)=>{return b.Equals(c)?1:0};this.AddOpToNativeFunc(this.Equal,2,ValueType.DivertTarget,a);}}AddOpFuncForType(a,b){null==this._operationFuncs&&(this._operationFuncs={}),this._operationFuncs[a]=b;}static AddOpToNativeFunc(a,b,c,d){var e=this._nativeFunctions[a];e||(e=NativeFunctionCall.internalConstructor(a,b),this._nativeFunctions[a]=e),e.AddOpFuncForType(c,d);}static AddIntBinaryOp(a,b){this.AddOpToNativeFunc(a,2,ValueType.Int,b);}static AddIntUnaryOp(a,b){this.AddOpToNativeFunc(a,1,ValueType.Int,b);}static AddFloatBinaryOp(a,b){this.AddOpToNativeFunc(a,2,ValueType.Float,b);}static AddFloatUnaryOp(a,b){this.AddOpToNativeFunc(a,1,ValueType.Float,b);}static AddStringBinaryOp(a,b){this.AddOpToNativeFunc(a,2,ValueType.String,b);}static AddListBinaryOp(a,b){this.AddOpToNativeFunc(a,2,ValueType.List,b);}static AddListUnaryOp(a,b){this.AddOpToNativeFunc(a,1,ValueType.List,b);}toString(){return'Native \''+this.name+'\''}}NativeFunctionCall.Add='+',NativeFunctionCall.Subtract='-',NativeFunctionCall.Divide='/',NativeFunctionCall.Multiply='*',NativeFunctionCall.Mod='%',NativeFunctionCall.Negate='_',NativeFunctionCall.Equal='==',NativeFunctionCall.Greater='>',NativeFunctionCall.Less='<',NativeFunctionCall.GreaterThanOrEquals='>=',NativeFunctionCall.LessThanOrEquals='<=',NativeFunctionCall.NotEquals='!=',NativeFunctionCall.Not='!',NativeFunctionCall.And='&&',NativeFunctionCall.Or='||',NativeFunctionCall.Min='MIN',NativeFunctionCall.Max='MAX',NativeFunctionCall.Has='?',NativeFunctionCall.Hasnt='!?',NativeFunctionCall.Intersect='^',NativeFunctionCall.ListMin='LIST_MIN',NativeFunctionCall.ListMax='LIST_MAX',NativeFunctionCall.All='LIST_ALL',NativeFunctionCall.Count='LIST_COUNT',NativeFunctionCall.ValueOfList='LIST_VALUE',NativeFunctionCall.Invert='LIST_INVERT',NativeFunctionCall._nativeFunctions=null;

	class Tag extends Object$1{constructor(a){super(),this._text=a.toString()||'';}get text(){return this._text}toString(){return'# '+this._text}}

	class Choice{constructor(a){this.text,this.index,this.choicePoint,this.threadAtGeneration,this._originalThreadIndex,this._originalChoicePath,a&&(this.choicePoint=a);}get pathStringOnChoice(){return this.choicePoint.pathStringOnChoice}get sourcePath(){return this.choicePoint.path.componentsString}}

	class ListDefinition{constructor(a,b){this._name=a||'',this._items=null,this._rawListItemsKeys=null,this._itemNameToValues=b||{};}get name(){return this._name}get items(){if(null==this._items)for(var a in this._items={},this._rawListItemsKeys={},this._itemNameToValues){var b=new RawListItem(this.name,a);this._rawListItemsKeys[b]=b,this._items[b]=this._itemNameToValues[a];}return this._items.forEach=this.forEachItems.bind(this),this._items}forEachItems(a){for(var b in this._rawListItemsKeys)a({Key:this._rawListItemsKeys[b],Value:this._items[b]});}ValueForItem(a){var b=this._itemNameToValues[a.itemName];return void 0===b?0:b}ContainsItem(a){return!(a.originName!=this.name)&&a.itemName in this._itemNameToValues}TryGetItemWithValue(a,b){for(var c in this._itemNameToValues)if(this._itemNameToValues[c]==a)return b=new RawListItem(this.name,c),{item:b,exists:!0};return b=RawListItem.Null,{item:b,exists:!1}}ListRange(a,b){var c=new RawList;for(var d in this._itemNameToValues)if(this._itemNameToValues[d]>=a&&this._itemNameToValues[d]<=b){var e=new RawListItem(this.name,d);c.Add(e,this._itemNameToValues[d]);}return new ListValue(c)}}

	class ListDefinitionsOrigin{constructor(a){this._lists={},a.forEach(b=>{this._lists[b.name]=b;});}get lists(){var a=[];for(var b in this._lists)a.push(this._lists[b]);return a}TryGetDefinition(a,b){return a in this._lists?this._lists[a]:b}FindSingleItemListWithName(a){var b=RawListItem.Null,c=null,d=a.split('.');if(2==d.length)b=new RawListItem(d[0],d[1]),c=this.TryGetDefinition(b.originName,c);else for(var e in this._lists){var f=this._lists[e];if(b=new RawListItem(e,a),f.ContainsItem(b)){c=f;break}}if(null!=c){var g=c.ValueForItem(b);return new ListValue(b,g)}return null}}

	class JsonSerialisation{static ListToJArray(a){var b=[];return a.forEach(c=>{b.push(this.RuntimeObjectToJToken(c));}),b}static JArrayToRuntimeObjList(a,b){var c=a.length;b&&c--;var d=[];for(var e=0;e<c;e++){var f=a[e],g=this.JTokenToRuntimeObject(f);d.push(g);}return d}static JObjectToDictionaryRuntimeObjs(a){var b={};for(var c in a)b[c]=this.JTokenToRuntimeObject(a[c]);return b}static DictionaryRuntimeObjsToJObject(a){var b={};for(var c in a){var d=a[c];d instanceof Object$1&&(b[c]=this.RuntimeObjectToJToken(d));}return b}static JObjectToIntDictionary(a){var b={};for(var c in a)b[c]=parseInt(a[c]);return b}static IntDictionaryToJObject(a){var b={};for(var c in a)b[c]=a[c];return b}static JTokenToRuntimeObject(a){if(!isNaN(a)&&'\n'!==a)return Value.Create(a);if('string'==typeof a){var b=a.toString(),c=b[0];if('^'==c)return new StringValue(b.substring(1));if('\n'==c&&1==b.length)return new StringValue('\n');if('<>'==b)return new Glue(GlueType.Bidirectional);if('G<'==b)return new Glue(GlueType.Left);if('G>'==b)return new Glue(GlueType.Right);for(var d=0;d<_controlCommandNames.length;++d){var e=_controlCommandNames[d];if(b==e)return new ControlCommand(d)}if('L^'==b&&(b='^'),NativeFunctionCall.CallExistsWithName(b))return NativeFunctionCall.CallWithName(b);if('->->'==b)return ControlCommand.PopTunnel();if('~ret'==b)return ControlCommand.PopFunction();if('void'==b)return new Void}if('object'==typeof a&&!1==a instanceof Array){var g,f=a;if(f['^->'])return g=f['^->'],new DivertTargetValue(new Path$1(g.toString()));if(f['^var']){g=f['^var'];var h=new VariablePointerValue(g.toString());return f.ci&&(g=f.ci,h.contextIndex=parseInt(g)),h}var j=!1,k=!1,l=PushPopType.Function,m=!1;if((g=f['->'])?j=!0:(g=f['f()'])?(j=!0,k=!0,l=PushPopType.Function):(g=f['->t->'])?(j=!0,k=!0,l=PushPopType.Tunnel):(g=f['x()'])&&(j=!0,m=!0,k=!1,l=PushPopType.Function),j){var n=new Divert;n.pushesToStack=k,n.stackPushType=l,n.isExternal=m;var o=g.toString();return(g=f['var'])?n.variableDivertName=o:n.targetPathString=o,n.isConditional=!!f.c,m&&(g=f.exArgs)&&(n.externalArgs=parseInt(g)),n}if(g=f['*']){var p=new ChoicePoint;return p.pathStringOnChoice=g.toString(),(g=f.flg)&&(p.flags=parseInt(g)),p}if(g=f['VAR?'])return new VariableReference(g.toString());if(g=f['CNT?']){var q=new VariableReference;return q.pathStringForCount=g.toString(),q}var r=!1,t=!1;if((g=f['VAR='])?(r=!0,t=!0):(g=f['temp='])&&(r=!0,t=!1),r){var u=g.toString(),v=!f.re,w=new VariableAssignment(u,v);return w.isGlobal=t,w}if(g=f['#'])return new Tag(g.toString());if(g=f.list){var x=g,y=new RawList;if(g=f.origins){var z=g;y.SetInitialOriginNames(z);}for(var A in x){var B=x[A],C=new RawListItem(A),D=parseInt(B);y.Add(C,D);}return new ListValue(y)}if(null!=f.originalChoicePath)return this.JObjectToChoice(f)}if(a instanceof Array)return this.JArrayToContainer(a);if(null==a)return null;throw'Failed to convert token to runtime object: '+JSON.stringify(a)}static RuntimeObjectToJToken(a){var b=a;if(b instanceof Container)return this.ContainerToJArray(b);var c=a;if(c instanceof Divert){var d='->';c.isExternal?d='x()':c.pushesToStack&&(c.stackPushType==PushPopType.Function?d='f()':c.stackPushType==PushPopType.Tunnel&&(d='->t->'));var e;e=c.hasVariableTarget?c.variableDivertName:c.targetPathString;var f={};return f[d]=e,c.hasVariableTarget&&(f['var']=!0),c.isConditional&&(f.c=!0),0<c.externalArgs&&(f.exArgs=c.externalArgs),f}var g=a;if(g instanceof ChoicePoint){var f={};return f['*']=g.pathStringOnChoice,f.flg=g.flags,f}var h=a;if(h instanceof IntValue)return h.value;var j=a;if(j instanceof FloatValue)return j.value;var k=a;if(k instanceof StringValue)return k.isNewline?'\n':'^'+k.value;var l=a;if(l instanceof ListValue)return this.InkListToJObject(l);var m=a;if(m instanceof DivertTargetValue)return{'^->':m.value.componentsString};var n=a;if(n instanceof VariablePointerValue)return{'^var':n.value,ci:n.contextIndex};var o=a;if(o instanceof Glue)return o.isBi?'<>':o.isLeft?'G<':'G>';var p=a;if(p instanceof ControlCommand)return _controlCommandNames[parseInt(p.commandType)];var q=a;if(q instanceof NativeFunctionCall){var r=q.name;return'^'==r&&(r='L^'),r}var t=a;if(t instanceof VariableReference){var f={},u=t.pathStringForCount;return null==u?f['VAR?']=t.name:f['CNT?']=u,f}var v=a;if(v instanceof VariableAssignment){var w=v.isGlobal?'VAR=':'temp=',f={};return f[w]=v.variableName,v.isNewDeclaration||(f.re=!0),f}if(a instanceof Void)return'void';var x=a;if(x instanceof Tag){var f={};return f['#']=x.text,f}var y=a;if(y instanceof Choice)return this.ChoiceToJObject(y);throw'Failed to convert runtime object to Json token: '+a}static ContainerToJArray(a){var b=this.ListToJArray(a.content),c=a.namedOnlyContent,d=a.countFlags;if(null!=c&&0<c.length||0<d||null!=a.name){var e;if(null!=c)for(var f in e=this.DictionaryRuntimeObjsToJObject(c),e){var g=e[f];if(null!=g){var h=g[g.length-1];null!=h&&(delete h['#n'],0==Object.keys(h).length&&(g[g.length-1]=null));}}else e={};0<d&&(e['#f']=d),null!=a.name&&(e['#n']=a.name),b.push(e);}else b.push(null);return b}static JArrayToContainer(a){var b=new Container;b.content=this.JArrayToRuntimeObjList(a,!0);var c=a[a.length-1];if(null!=c){var d={};for(var e in c)if('#f'==e)b.countFlags=parseInt(c[e]);else if('#n'==e)b.name=c[e].toString();else{var f=this.JTokenToRuntimeObject(c[e]),g=f;g instanceof Container&&(g.name=e),d[e]=f;}b.namedOnlyContent=d;}return b}static JObjectToChoice(a){var b=new Choice;return b.text=a.text.toString(),b.index=parseInt(a.index),b.originalChoicePath=a.originalChoicePath.toString(),b.originalThreadIndex=parseInt(a.originalThreadIndex),b}static ChoiceToJObject(a){var b={};return b.text=a.text,b.index=a.index,b.originalChoicePath=a.originalChoicePath,b.originalThreadIndex=a.originalThreadIndex,b}static InkListToJObject(a){var b=a.value,c={},d={};return b.forEach(function(e){var f=e.Key,g=e.Value;d[f.toString()]=g;}),c.list=d,0==b.Count&&null!=b.originNames&&0<b.originNames.length&&(c.origins=b.originNames),c}static ListDefinitionsToJToken(a){var b={};return a.lists.forEach(function(c){var d={};c.items.forEach(function(e){var f=e.Key,g=e.Value;d[f.itemName]=g;}),b[c.name]=d;}),b}static JTokenToListDefinitions(a){var b=a,c=[];for(var d in b){var e=d.toString(),f=b[d],g={};for(var h in f){var j=f[h];g[h]=parseInt(j);}var k=new ListDefinition(e,g);c.push(k);}return new ListDefinitionsOrigin(c)}}var _controlCommandNames=[];_controlCommandNames[ControlCommand.CommandType.EvalStart]='ev',_controlCommandNames[ControlCommand.CommandType.EvalOutput]='out',_controlCommandNames[ControlCommand.CommandType.EvalEnd]='/ev',_controlCommandNames[ControlCommand.CommandType.Duplicate]='du',_controlCommandNames[ControlCommand.CommandType.PopEvaluatedValue]='pop',_controlCommandNames[ControlCommand.CommandType.PopFunction]='~ret',_controlCommandNames[ControlCommand.CommandType.PopTunnel]='->->',_controlCommandNames[ControlCommand.CommandType.BeginString]='str',_controlCommandNames[ControlCommand.CommandType.EndString]='/str',_controlCommandNames[ControlCommand.CommandType.NoOp]='nop',_controlCommandNames[ControlCommand.CommandType.ChoiceCount]='choiceCnt',_controlCommandNames[ControlCommand.CommandType.TurnsSince]='turns',_controlCommandNames[ControlCommand.CommandType.Random]='rnd',_controlCommandNames[ControlCommand.CommandType.SeedRandom]='srnd',_controlCommandNames[ControlCommand.CommandType.VisitIndex]='visit',_controlCommandNames[ControlCommand.CommandType.SequenceShuffleIndex]='seq',_controlCommandNames[ControlCommand.CommandType.StartThread]='thread',_controlCommandNames[ControlCommand.CommandType.Done]='done',_controlCommandNames[ControlCommand.CommandType.End]='end',_controlCommandNames[ControlCommand.CommandType.ListFromInt]='listInt',_controlCommandNames[ControlCommand.CommandType.ListRange]='range';for(var i$1=0;i$1<ControlCommand.CommandType.TOTAL_VALUES;++i$1)if(null==_controlCommandNames[i$1])throw'Control command not accounted for in serialisation';

	class Element{constructor(a,b,c,d){this.currentContainer=b,this.currentContentIndex=c,this.inExpressionEvaluation=d||!1,this.temporaryVariables={},this.type=a;}get currentObject(){return this.currentContainer&&this.currentContentIndex<this.currentContainer.content.length?this.currentContainer.content[this.currentContentIndex]:null}set currentObject(a){var b=a;return null==b?(this.currentContainer=null,void(this.currentContentIndex=0)):void(this.currentContainer=b.parent,this.currentContainer instanceof Container&&(this.currentContentIndex=this.currentContainer.content.indexOf(b)),(!1==this.currentContainer instanceof Container||-1==this.currentContentIndex)&&(this.currentContainer=b,this.currentContentIndex=0))}Copy(){var a=new Element(this.type,this.currentContainer,this.currentContentIndex,this.inExpressionEvaluation);return Object.assign(a.temporaryVariables,this.temporaryVariables),a}}class Thread{constructor(a,b){if(this.callstack=[],this.threadIndex=0,this.previousContentObject=null,a&&b){var c=a;this.threadIndex=parseInt(c.threadIndex);var d=c.callstack;d.forEach(h=>{var i=h,j=parseInt(i.type),k=null,l=0,m=null,n=i.cPath;'undefined'!=typeof n&&(m=n.toString(),k=b.ContentAtPath(new Path$1(m)),l=parseInt(i.idx));var o=!!i.exp,p=new Element(j,k,l,o),q=i.temp;p.temporaryVariables=JsonSerialisation.JObjectToDictionaryRuntimeObjs(q),this.callstack.push(p);});var f=c.previousContentObject;if('undefined'!=typeof f){var g=new Path$1(f.toString());this.previousContentObject=b.ContentAtPath(g);}}}get jsonToken(){var a={},b=[];return this.callstack.forEach(c=>{var d={};c.currentContainer&&(d.cPath=c.currentContainer.path.componentsString,d.idx=c.currentContentIndex),d.exp=c.inExpressionEvaluation,d.type=parseInt(c.type),d.temp=JsonSerialisation.DictionaryRuntimeObjsToJObject(c.temporaryVariables),b.push(d);}),a.callstack=b,a.threadIndex=this.threadIndex,null!=this.previousContentObject&&(a.previousContentObject=this.previousContentObject.path.toString()),a}Copy(){var a=new Thread;return a.threadIndex=this.threadIndex,this.callstack.forEach(b=>{a.callstack.push(b.Copy());}),a.previousContentObject=this.previousContentObject,a}}class CallStack{constructor(a){this._threads=[],this._threadCounter=0,this._threads.push(new Thread),a instanceof CallStack?(this._threads=[],a._threads.forEach(b=>{this._threads.push(b.Copy());})):this._threads[0].callstack.push(new Element(PushPopType.Tunnel,a,0));}get currentThread(){return this._threads[this._threads.length-1]}set currentThread(a){1!=this._threads.length&&console.warn('Shouldn\'t be directly setting the current thread when we have a stack of them'),this._threads.length=0,this._threads.push(a);}get callStack(){return this.currentThread.callstack}get elements(){return this.callStack}get currentElement(){return this.callStack[this.callStack.length-1]}get currentElementIndex(){return this.callStack.length-1}get canPop(){return 1<this.callStack.length}get canPopThread(){return 1<this._threads.length}CanPop(a){return!!this.canPop&&(!(null!=a)||this.currentElement.type==a)}Pop(a){if(this.CanPop(a))this.callStack.pop();else throw'Mismatched push/pop in Callstack'}Push(a){this.callStack.push(new Element(a,this.currentElement.currentContainer,this.currentElement.currentContentIndex,!1));}PushThread(){var a=this.currentThread.Copy();a.threadIndex=this._threadCounter,this._threadCounter++,this._threads.push(a);}PopThread(){if(this.canPopThread)this._threads.splice(this._threads.indexOf(this.currentThread),1);else throw'Can\'t pop thread'}SetJsonToken(a,b){this._threads.length=0;var c=a,d=c.threads;d.forEach(f=>{var g=new Thread(f,b);this._threads.push(g);}),this._threadCounter=parseInt(c.threadCounter);}GetJsonToken(){var a={},b=[];return this._threads.forEach(c=>{b.push(c.jsonToken);}),a.threads=b,a.threadCounter=this._threadCounter,a}GetTemporaryVariableWithName(a,b){b='undefined'==typeof b?-1:b,-1==b&&(b=this.currentElementIndex+1);var c=null,d=this.callStack[b-1];return(c=d.temporaryVariables[a])?c:null}SetTemporaryVariable(a,b,c,d){d='undefined'==typeof d?-1:d,-1==d&&(d=this.currentElementIndex+1);var f=this.callStack[d-1];if(!c&&!f.temporaryVariables[a])throw new StoryException('Could not find temporary variable to set: '+a);var g;(g=f.temporaryVariables[a])&&ListValue.RetainListOriginsForAssignment(g,b),f.temporaryVariables[a]=b;}ContextForVariableNamed(a){return this.currentElement.temporaryVariables[a]?this.currentElementIndex+1:0}ThreadWithIndex(a){var b=this._threads.filter(c=>{if(c.threadIndex==a)return c});return b[0]}}

	class VariablesState{constructor(a,b){this._globalVariables={},this._callStack=a,this._listDefsOrigin=b,this._batchObservingVariableChanges=null,this._changedVariables=null,this.variableChangedEvent=null,this.variableChangedEventCallbacks=[];try{var c=new Proxy(this,{get:function(d,f){return f in d?d[f]:d.$(f)},set:function(d,f,g){return f in d?d[f]=g:d.$(f,g),!0}});return c}catch(d){}}get batchObservingVariableChanges(){return this._batchObservingVariableChanges}set batchObservingVariableChanges(a){a=!!a,this._batchObservingVariableChanges=a,a?this._changedVariables=[]:(null!=this._changedVariables&&this._changedVariables.forEach(b=>{var c=this._globalVariables[b];this.variableChangedEvent(b,c);}),this._changedVariables=null);}get jsonToken(){return JsonSerialisation.DictionaryRuntimeObjsToJObject(this._globalVariables)}set jsonToken(a){this._globalVariables=JsonSerialisation.JObjectToDictionaryRuntimeObjs(a);}ObserveVariableChange(a){null==this.variableChangedEvent&&(this.variableChangedEvent=(b,c)=>{this.variableChangedEventCallbacks.forEach(d=>{d(b,c);});}),this.variableChangedEventCallbacks.push(a);}CopyFrom(a){this._globalVariables=Object.assign({},a._globalVariables),this.variableChangedEvent=a.variableChangedEvent,a.batchObservingVariableChanges!=this.batchObservingVariableChanges&&(a.batchObservingVariableChanges?(this._batchObservingVariableChanges=!0,this._changedVariables=a._changedVariables):(this._batchObservingVariableChanges=!1,this._changedVariables=null));}GetVariableWithName(a,b){'undefined'==typeof b&&(b=-1);var c=this.GetRawVariableWithName(a,b),d=c;return d instanceof VariablePointerValue&&(c=this.ValueAtVariablePointer(d)),c}GetRawVariableWithName(a,b){var c=null;if(0==b||-1==b){if(c=this._globalVariables[a])return c;var d=this._listDefsOrigin.FindSingleItemListWithName(a);if(d)return d}if(c=this._callStack.GetTemporaryVariableWithName(a,b),null==c)throw'RUNTIME ERROR: Variable \''+a+'\' could not be found in context \''+b+'\'. This shouldn\'t be possible so is a bug in the ink engine. Please try to construct a minimal story that reproduces the problem and report to inkle, thank you!';return c}ValueAtVariablePointer(a){return this.GetVariableWithName(a.variableName,a.contextIndex)}Assign(a,b){var c=a.variableName,d=-1,f=!1;if(f=a.isNewDeclaration?a.isGlobal:!!this._globalVariables[c],a.isNewDeclaration){var g=b;if(g instanceof VariablePointerValue){var h=this.ResolveVariablePointer(g);b=h;}}else{var i=null;do i=this.GetRawVariableWithName(c,d),i instanceof VariablePointerValue&&(c=i.variableName,d=i.contextIndex,f=0==d);while(i instanceof VariablePointerValue)}f?this.SetGlobal(c,b):this._callStack.SetTemporaryVariable(c,b,a.isNewDeclaration,d);}RetainListOriginsForAssignment(a,b){var c=a,d=b;c instanceof ListValue&&d instanceof ListValue&&0==d.value.Count&&d.value.SetInitialOriginNames(c.value.originNames);}SetGlobal(a,b){var c=null;c=this._globalVariables[a],ListValue.RetainListOriginsForAssignment(c,b),this._globalVariables[a]=b,null!=this.variableChangedEvent&&b!==c&&(this.batchObservingVariableChanges?this._changedVariables.push(a):this.variableChangedEvent(a,b));}ResolveVariablePointer(a){var b=a.contextIndex;-1==b&&(b=this.GetContextIndexOfVariableNamed(a.variableName));var c=this.GetRawVariableWithName(a.variableName,b),d=c;return d instanceof VariablePointerValue?d:new VariablePointerValue(a.variableName,b)}GetContextIndexOfVariableNamed(a){return this._globalVariables[a]?0:this._callStack.currentElementIndex}$(a,b){if('undefined'==typeof b){var c=this._globalVariables[a];return'undefined'==typeof c?null:c.valueObject}if('undefined'==typeof this._globalVariables[a])throw new StoryException('Variable \''+a+'\' doesn\'t exist, so can\'t be set.');var d=Value.Create(b);if(null==d)if(null==b)throw new StoryException('Cannot pass null to VariableState');else throw new StoryException('Invalid value passed to VariableState: '+b.toString());this.SetGlobal(a,d);}}

	class PRNG{constructor(a){this._seed=a%2147483647,0>=this._seed&&(this._seed+=2147483646);}next(){return this._seed=16807*this._seed%2147483647}nextFloat(){return(this.next()-1)/2147483646}}

	class StoryState{constructor(a){this.story=a,this._outputStream=[],this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this.OutputStreamDirty(),this._evaluationStack=[],this.callStack=new CallStack(a.rootContentContainer),this._variablesState=new VariablesState(this.callStack,a.listDefinitions),this._visitCounts={},this._turnIndices={},this._currentTurnIndex=-1,this.divertedTargetObject=null;var b=new Date().getTime();this.storySeed=new PRNG(b).next()%100,this.previousRandom=0,this._currentChoices=[],this._currentText=null,this._currentTags=null,this._currentErrors=null,this.didSafeExit=!1,this._isExternalFunctionEvaluation=!1,this._originalCallstack=null,this._originalEvaluationStackHeight=0,this.GoToStart();}get currentChoices(){return this.canContinue?[]:this._currentChoices}get generatedChoices(){return this._currentChoices}get currentErrors(){return this._currentErrors}get visitCounts(){return this._visitCounts}get turnIndices(){return this._turnIndices}get currentTurnIndex(){return this._currentTurnIndex}get variablesState(){return this._variablesState}get currentContentObject(){return this.callStack.currentElement.currentObject}set currentContentObject(a){this.callStack.currentElement.currentObject=a;}get canContinue(){return null!=this.currentContentObject&&!this.hasError}get hasError(){return null!=this.currentErrors&&0<this.currentErrors.length}get inExpressionEvaluation(){return this.callStack.currentElement.inExpressionEvaluation}set inExpressionEvaluation(a){this.callStack.currentElement.inExpressionEvaluation=a;}get evaluationStack(){return this._evaluationStack}get outputStreamEndsInNewline(){if(0<this._outputStream.length)for(var a=this._outputStream.length-1;0<=a;a--){var b=this._outputStream[a];if(b instanceof ControlCommand)break;var d=this._outputStream[a];if(d instanceof StringValue){if(d.isNewline)return!0;if(d.isNonWhitespace)break}}return!1}get outputStreamContainsContent(){for(var a=0;a<this._outputStream.length;a++)if(this._outputStream[a]instanceof StringValue)return!0;return!1}get currentGlueIndex(){for(var a=this._outputStream.length-1;0<=a;a--){var b=this._outputStream[a];if(b instanceof Glue)return a;if(b instanceof ControlCommand)break}return-1}get currentRightGlue(){for(var a=this._outputStream.length-1;0<=a;a--){var b=this._outputStream[a],d=b;if(d instanceof Glue&&d.isRight)return d;if(b instanceof ControlCommand)break}return null}get inStringEvaluation(){for(var a=this._outputStream.length-1;0<=a;a--){var b=this._outputStream[a];if(b instanceof ControlCommand&&b.commandType==ControlCommand.CommandType.BeginString)return!0}return!1}get currentText(){if(this._outputStreamTextDirty){var a=new StringBuilder;this._outputStream.forEach(b=>{var d=b;d instanceof StringValue&&a.Append(d.value);}),this._currentText=a.toString(),this._outputStreamTextDirty=!1;}return this._currentText}get currentTags(){return this._outputStreamTagsDirty&&(this._currentTags=[],this._outputStream.forEach(a=>{var b=a;b instanceof Tag&&this._currentTags.push(b.text);}),this._outputStreamTagsDirty=!1),this._currentTags}get outputStream(){return this._outputStream}get currentPath(){return null==this.currentContentObject?null:this.currentContentObject.path}set currentPath(a){this.currentContentObject=null==a?null:this.story.ContentAtPath(a);}get currentContainer(){return this.callStack.currentElement.currentContainer}get previousContentObject(){return this.callStack.currentThread.previousContentObject}set previousContentObject(a){this.callStack.currentThread.previousContentObject=a;}get jsonToken(){var a={},b=null;return this._currentChoices.forEach(d=>{d.originalChoicePath=d.choicePoint.path.componentsString,d.originalThreadIndex=d.threadAtGeneration.threadIndex,null==this.callStack.ThreadWithIndex(d.originalThreadIndex)&&(null==b&&(b={}),b[d.originalThreadIndex.toString()]=d.threadAtGeneration.jsonToken);}),null!=this.choiceThreads&&(a.choiceThreads=this.choiceThreads),a.callstackThreads=this.callStack.GetJsonToken(),a.variablesState=this.variablesState.jsonToken,a.evalStack=JsonSerialisation.ListToJArray(this.evaluationStack),a.outputStream=JsonSerialisation.ListToJArray(this._outputStream),a.currentChoices=JsonSerialisation.ListToJArray(this._currentChoices),null!=this.divertedTargetObject&&(a.currentDivertTarget=this.divertedTargetObject.path.componentsString),a.visitCounts=JsonSerialisation.IntDictionaryToJObject(this.visitCounts),a.turnIndices=JsonSerialisation.IntDictionaryToJObject(this.turnIndices),a.turnIdx=this.currentTurnIndex,a.storySeed=this.storySeed,a.inkSaveVersion=StoryState.kInkSaveStateVersion,a.inkFormatVersion=this.story.inkVersionCurrent,a}set jsonToken(a){var b=a,d=b.inkSaveVersion;if(null==d)throw new StoryException('ink save format incorrect, can\'t load.');else if(parseInt(d)<StoryState.kMinCompatibleLoadVersion)throw new StoryException('Ink save format isn\'t compatible with the current version (saw \''+d+'\', but minimum is '+StoryState.kMinCompatibleLoadVersion+'), so can\'t load.');this.callStack.SetJsonToken(b.callstackThreads,this.story),this.variablesState.jsonToken=b.variablesState,this._evaluationStack=JsonSerialisation.JArrayToRuntimeObjList(b.evalStack),this._outputStream=JsonSerialisation.JArrayToRuntimeObjList(b.outputStream),this.OutputStreamDirty(),this._currentChoices=JsonSerialisation.JArrayToRuntimeObjList(b.currentChoices);var e=b.currentDivertTarget;if(null!=e){var f=new Path$1(e.toString());this.divertedTargetObject=this.story.ContentAtPath(f);}this._visitCounts=JsonSerialisation.JObjectToIntDictionary(b.visitCounts),this._turnIndices=JsonSerialisation.JObjectToIntDictionary(b.turnIndices),this._currentTurnIndex=parseInt(b.turnIdx),this.storySeed=parseInt(b.storySeed);var h=b.choiceThreads;this._currentChoices.forEach(j=>{j.choicePoint=this.story.ContentAtPath(new Path$1(j.originalChoicePath));var k=this.callStack.ThreadWithIndex(j.originalThreadIndex);if(null!=k)j.threadAtGeneration=k;else{var l=h[j.originalThreadIndex.toString()];j.threadAtGeneration=new CallStack.Thread(l,this.story);}});}MatchRightGlueForLeftGlue(a){if(!a.isLeft)return null;for(var b=this._outputStream.length-1;0<=b;b--){var d=this._outputStream[b],e=d;if(e instanceof Glue&&e.isRight&&e.parent==a.parent)return e;if(d instanceof ControlCommand)break}return null}GoToStart(){this.callStack.currentElement.currentContainer=this.story.mainContentContainer,this.callStack.currentElement.currentContentIndex=0;}ResetErrors(){this._currentErrors=null;}ResetOutput(){this._outputStream.length=0,this.OutputStreamDirty();}PushEvaluationStack(a){var b=a;if(b instanceof ListValue){var d=b.value,e=d.originNames;if(null!=e){var f=[];e.forEach(h=>{var j=null;j=this.story.listDefinitions.TryGetDefinition(h,j),0>f.indexOf(j)&&f.push(j);}),d.origins=f;}}this.evaluationStack.push(a);}PopEvaluationStack(a){if(!a){var b=this.evaluationStack.pop();return b}if(a>this.evaluationStack.length)throw'trying to pop too many objects';var d=this.evaluationStack.splice(this.evaluationStack.length-a,a);return d}PeekEvaluationStack(){return this.evaluationStack[this.evaluationStack.length-1]}PushToOutputStream(a){var b=a;if(b instanceof StringValue){var d=this.TrySplittingHeadTailWhitespace(b);if(null!=d)return void d.forEach(e=>{this.PushToOutputStreamIndividual(e);})}this.PushToOutputStreamIndividual(a),this.OutputStreamDirty();}TrySplittingHeadTailWhitespace(a){var b=a.value,d=-1,e=-1;for(var f=0;f<b.length;++f){var h=b[f];if('\n'==h)-1==d&&(d=f),e=f;else if(' '==h||'\t'==h)continue;else break}var j=-1,k=-1;for(var f=0;f<b.length;++f){var h=b[f];if('\n'==h)-1==j&&(j=f),k=f;else if(' '==h||'\t'==h)continue;else break}if(-1==d&&-1==j)return null;var l=[],m=0,o=b.length;if(-1!=d){if(0<d){var p=b.substring(0,d);l.push(p);}l.push(new StringValue('\n')),m=e+1;}if(-1!=j&&(o=k),o>m){var q=b.substring(m,o-m);l.push(new StringValue(q));}if(-1!=j&&k>e&&(l.push(new StringValue('\n')),j<b.length-1)){var r=b.Length-j-1,s=new StringValue(b.substring(j+1,r));l.push(s);}return l}PushToOutputStreamIndividual(a){var b=a,d=a,e=!0;if(b instanceof Glue){var f=this.currentRightGlue;!!(b.isLeft&&f&&b.parent==f.parent);var h=null;b.isLeft&&(h=this.MatchRightGlueForLeftGlue(b)),(b.isLeft||b.isBi)&&this.TrimNewlinesFromOutputStream(h),e=b.isBi||b.isRight;}else d instanceof StringValue&&(-1==this.currentGlueIndex?d.isNewline&&(this.outputStreamEndsInNewline||!this.outputStreamContainsContent)&&(e=!1):d.isNewline?(this.TrimFromExistingGlue(),e=!1):d.isNonWhitespace&&this.RemoveExistingGlue());e&&(this._outputStream.push(a),this.OutputStreamDirty());}TrimNewlinesFromOutputStream(a){for(var b=-1,d=-1,e=!1,f=this._outputStream.length-1;0<=f;){var h=this._outputStream[f],j=h,k=h;if(h instanceof ControlCommand||j instanceof StringValue&&j.isNonWhitespace){if(e=!0,null==a)break;}else if(a&&k instanceof Glue&&k==a){d=f;break}else j instanceof StringValue&&j.isNewline&&!e&&(b=f);f--;}if(0<=b)for(f=b;f<this._outputStream.length;){var l=this._outputStream[f];l instanceof StringValue?this._outputStream.splice(f,1):f++;}if(a&&-1<d)for(f=d;f<this._outputStream.length;)this._outputStream[f]instanceof Glue&&this._outputStream[f].isRight?this.outputStream.splice(f,1):f++;this.OutputStreamDirty();}TrimFromExistingGlue(){for(var a=this.currentGlueIndex;a<this._outputStream.length;){var b=this._outputStream[a];b instanceof StringValue&&!b.isNonWhitespace?this._outputStream.splice(a,1):a++;}this.OutputStreamDirty();}RemoveExistingGlue(){for(var a=this._outputStream.length-1;0<=a;a--){var b=this._outputStream[a];if(b instanceof Glue)this._outputStream.splice(a,1);else if(b instanceof ControlCommand)break}this.OutputStreamDirty();}ForceEnd(){for(;this.callStack.canPopThread;)this.callStack.PopThread();for(;this.callStack.canPop;)this.callStack.Pop();this._currentChoices.length=0,this.currentContentObject=null,this.previousContentObject=null,this.didSafeExit=!0;}SetChosenPath(a){this._currentChoices.length=0,this.currentPath=a,this._currentTurnIndex++;}StartExternalFunctionEvaluation(a,b){if(this._originalCallstack=this.callStack,this._originalEvaluationStackHeight=this.evaluationStack.length,this.callStack=new CallStack(a),this.callStack.currentElement.type=PushPopType.Function,this._isExternalFunctionEvaluation=!0,null!=b)for(var d=0;d<b.length;d++){if('number'!=typeof b[d]&&'string'!=typeof b[d])throw'ink arguments when calling EvaluateFunction must be int, float or string';this.PushEvaluationStack(Value.Create(b[d]));}}TryExitExternalFunctionEvaluation(){return this._isExternalFunctionEvaluation&&1==this.callStack.elements.length&&this.callStack.currentElement.type==PushPopType.Function&&(this.currentContentObject=null,this.didSafeExit=!0,!0)}CompleteExternalFunctionEvaluation(){for(var a=null;this.evaluationStack.length>this._originalEvaluationStackHeight;){var b=this.PopEvaluationStack();null==a&&(a=b);}if(this.callStack=this._originalCallstack,this._originalCallstack=null,this._originalEvaluationStackHeight=0,a){if(a instanceof Void)return null;var d=a;return d.valueType==ValueType.DivertTarget?d.valueObject.toString():d.valueObject}return null}AddError(a){null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(a);}OutputStreamDirty(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0;}VisitCountAtPathString(a){var b;return(b=this.visitCounts[a])?b:0}Copy(){var a=new StoryState(this.story);for(var b in a.outputStream.push.apply(a.outputStream,this._outputStream),this.OutputStreamDirty(),a._currentChoices.push.apply(a._currentChoices,this._currentChoices),this.hasError&&(a.currentErrors=[],a.currentErrors.push.apply(a.currentErrors,this.currentErrors)),a.callStack=new CallStack(this.callStack),a._variablesState=new VariablesState(a.callStack,this.story.listDefinitions),a.variablesState.CopyFrom(this.variablesState),a.evaluationStack.push.apply(a.evaluationStack,this.evaluationStack),null!=this.divertedTargetObject&&(a.divertedTargetObject=this.divertedTargetObject),a.previousContentObject=this.previousContentObject,a._isExternalFunctionEvaluation=this._isExternalFunctionEvaluation,a._visitCounts={},this._visitCounts)a._visitCounts[b]=this._visitCounts[b];for(var b in a._turnIndices={},this._turnIndices)a._turnIndices[b]=this._turnIndices[b];return a._currentTurnIndex=this.currentTurnIndex,a.storySeed=this.storySeed,a.previousRandom=this.previousRandom,a.didSafeExit=this.didSafeExit,a}toJson(a){return JSON.stringify(this.jsonToken,null,a?2:0)}LoadJson(a){this.jsonToken=JSON.parse(a);}}StoryState.kInkSaveStateVersion=6,StoryState.kMinCompatibleLoadVersion=6;

	Number.isInteger||(Number.isInteger=function(b){return'number'==typeof b&&isFinite(b)&&-9007199254740992<b&&9007199254740992>b&&Math.floor(b)===b});class Story extends Object$1{constructor(a,b){if(super(),b=b||null,this.inkVersionCurrent=16,this.inkVersionMinimumCompatible=16,this._variableObservers=null,this._externals={},this._prevContainerSet=null,this._listDefinitions=null,a instanceof Container)this._mainContentContainer=a,null!=b&&(this._listDefinitions=new ListDefinitionsOrigin(b));else{var d='string'==typeof a?JSON.parse(a):a,f=d.inkVersion;if(null==f)throw'ink version number not found. Are you sure it\'s a valid .ink.json file?';var g=parseInt(f);if(g>this.inkVersionCurrent)throw'Version of ink used to build story was newer than the current verison of the engine';else if(g<this.inkVersionMinimumCompatible)throw'Version of ink used to build story is too old to be loaded by this verison of the engine';else g!=this.inkVersionCurrent&&console.warn('WARNING: Version of ink used to build story doesn\'t match current version of engine. Non-critical, but recommend synchronising.');var h=d.root;if(null==h)throw'Root node for ink not found. Are you sure it\'s a valid .ink.json file?';var j;(j=d.listDefs)&&(this._listDefinitions=JsonSerialisation.JTokenToListDefinitions(j)),this._mainContentContainer=JsonSerialisation.JTokenToRuntimeObject(h),this._hasValidatedExternals=null,this.allowExternalFunctionFallbacks=!1,this.ResetState();}}get currentChoices(){var a=[];return this._state.currentChoices.forEach(b=>{b.choicePoint.isInvisibleDefault||(b.index=a.length,a.push(b));}),a}get currentText(){return this.state.currentText}get currentTags(){return this.state.currentTags}get currentErrors(){return this.state.currentErrors}get hasError(){return this.state.hasError}get variablesState(){return this.state.variablesState}get listDefinitions(){return this._listDefinitions}get state(){return this._state}get mainContentContainer(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}get canContinue(){return this.state.canContinue}get globalTags(){return this.TagsAtStartOfFlowContainerWithPathString('')}ToJsonString(){var a=JsonSerialisation.RuntimeObjectToJToken(this._mainContentContainer),b={};return b.inkVersion=this.inkVersionCurrent,b.root=a,null!=this._listDefinitions&&(b.listDefs=JsonSerialisation.ListDefinitionsToJToken(this._listDefinitions)),JSON.stringify(b)}ResetState(){this._state=new StoryState(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals();}ResetErrors(){this._state.ResetErrors();}ResetCallstack(){this._state.ForceEnd();}ResetGlobals(){if(this._mainContentContainer.namedContent['global decl']){var a=this.state.currentPath;this.ChoosePathString('global decl'),this.ContinueInternal(),this.state.currentPath=a;}}Continue(){return this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal()}ContinueInternal(){if(!this.canContinue)throw new StoryException('Can\'t continue - should check canContinue before calling Continue');this._state.ResetOutput(),this._state.didSafeExit=!1,this._state.variablesState.batchObservingVariableChanges=!0;try{var a=null;do if(this.Step(),this.canContinue||this.TryFollowDefaultInvisibleChoice(),!this.state.inStringEvaluation){if(null!=a){var b=this.currentText,d=a.currentText.length,f=a.currentTags.length;if(b!==a.currentText||f!=this.currentTags.length)if(b.length>=d&&'\n'==b[d-1]){this.RestoreStateSnapshot(a);break}else a=null;}this.state.outputStreamEndsInNewline&&(this.canContinue?null==a&&(a=this.StateSnapshot()):a=null);}while(this.canContinue);null!=a&&this.RestoreStateSnapshot(a),this.canContinue||(this.state.callStack.canPopThread&&this.Error('Thread available to pop, threads should always be flat by the end of evaluation?'),0==this.state.generatedChoices.length&&!this.state.didSafeExit&&null==this._temporaryEvaluationContainer&&(this.state.callStack.CanPop(PushPopType.Tunnel)?this.Error('unexpectedly reached end of content. Do you need a \'->->\' to return from a tunnel?'):this.state.callStack.CanPop(PushPopType.Function)?this.Error('unexpectedly reached end of content. Do you need a \'~ return\'?'):this.state.callStack.canPop?this.Error('unexpectedly reached end of content for unknown reason. Please debug compiler!'):this.Error('ran out of content. Do you need a \'-> DONE\' or \'-> END\'?')));}catch(g){throw g}finally{this.state.didSafeExit=!1,this._state.variablesState.batchObservingVariableChanges=!1;}return this.currentText}ContinueMaximally(){for(var a=new StringBuilder;this.canContinue;)a.Append(this.Continue());return a.toString()}ContentAtPath(a){return this.mainContentContainer.ContentAtPath(a)}StateSnapshot(){return this.state.Copy()}RestoreStateSnapshot(a){this._state=a;}Step(){var a=!0,b=this.state.currentContentObject;if(null!=b){for(var d=b;d instanceof Container&&(this.VisitContainer(d,!0),0!=d.content.length);)b=d.content[0],this.state.callStack.currentElement.currentContentIndex=0,this.state.callStack.currentElement.currentContainer=d,d=b;d=this.state.callStack.currentElement.currentContainer;var f=this.PerformLogicAndFlowControl(b);if(null!=this.state.currentContentObject){f&&(a=!1);var g=b;if(g instanceof ChoicePoint){var h=this.ProcessChoice(g);h&&this.state.generatedChoices.push(h),b=null,a=!1;}if(b instanceof Container&&(a=!1),a){var j=b;if(j instanceof VariablePointerValue&&-1==j.contextIndex){var k=this.state.callStack.ContextForVariableNamed(j.variableName);b=new VariablePointerValue(j.variableName,k);}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(b):this.state.PushToOutputStream(b);}this.NextContent();var m=b;m instanceof ControlCommand&&m.commandType==ControlCommand.CommandType.StartThread&&this.state.callStack.PushThread();}}}VisitContainer(a,b){(!a.countingAtStartOnly||b)&&(a.visitsShouldBeCounted&&this.IncrementVisitCountForContainer(a),a.turnIndexShouldBeCounted&&this.RecordTurnIndexVisitToContainer(a));}VisitChangedContainersDueToDivert(){var a=this.state.previousContentObject,b=this.state.currentContentObject;if(b){if(null==this._prevContainerSet&&(this._prevContainerSet=[]),a)for(var d=a instanceof Container?a:a.parent;d instanceof Container;)this._prevContainerSet.push(d),d=d.parent;for(var f=b,g=f.parent;g instanceof Container&&0>this._prevContainerSet.indexOf(g);){var h=0<g.content.length&&f==g.content[0];this.VisitContainer(g,h),f=g,g=g.parent;}}}ProcessChoice(a){var b=!0;if(a.hasCondition){var d=this.state.PopEvaluationStack();this.IsTruthy(d)||(b=!1);}var f='',g='';if(a.hasChoiceOnlyContent){var h=this.state.PopEvaluationStack();g=h.value;}if(a.hasStartContent){var j=this.state.PopEvaluationStack();f=j.value;}if(a.onceOnly){var k=this.VisitCountForContainer(a.choiceTarget);0<k&&(b=!1);}var m=new Choice(a);return(m.threadAtGeneration=this.state.callStack.currentThread.Copy(),!b)?null:(m.text=f+g,m)}IsTruthy(a){if(a instanceof Value){var b=a;return b instanceof DivertTargetValue?(this.Error('Shouldn\'t use a divert target (to '+b.targetPath+') as a conditional value. Did you intend a function call \'likeThis()\' or a read count check \'likeThis\'? (no arrows)'),!1):b.isTruthy}return!1}PerformLogicAndFlowControl(a){if(null==a)return!1;if(a instanceof Divert){var b=a;if(b.isConditional){var d=this.state.PopEvaluationStack();if(!this.IsTruthy(d))return!0}if(b.hasVariableTarget){var f=b.variableDivertName,g=this.state.variablesState.GetVariableWithName(f);if(!(g instanceof DivertTargetValue)){var h=g,j='Tried to divert to a target from a variable, but the variable ('+f+') didn\'t contain a divert target, it ';j+=h instanceof IntValue&&0==h.value?'was empty/null (the value 0).':'contained \''+g+'\'.',this.Error(j);}var k=g;this.state.divertedTargetObject=this.ContentAtPath(k.targetPath);}else{if(b.isExternal)return this.CallExternalFunction(b.targetPathString,b.externalArgs),!0;this.state.divertedTargetObject=b.targetContent;}return b.pushesToStack&&this.state.callStack.Push(b.stackPushType),null!=this.state.divertedTargetObject||b.isExternal||(b&&null!=b.debugMetadata.sourceName?this.Error('Divert target doesn\'t exist: '+b.debugMetadata.sourceName):this.Error('Divert resolution failed: '+b)),!0}if(a instanceof ControlCommand){var m=a;switch(m.commandType){case ControlCommand.CommandType.EvalStart:this.state.inExpressionEvaluation&&console.warn('Already in expression evaluation?'),this.state.inExpressionEvaluation=!0;break;case ControlCommand.CommandType.EvalEnd:this.state.inExpressionEvaluation||console.warn('Not in expression evaluation mode'),this.state.inExpressionEvaluation=!1;break;case ControlCommand.CommandType.EvalOutput:if(0<this.state.evaluationStack.length){var n=this.state.PopEvaluationStack();if(!(n instanceof Void)){var p=new StringValue(n.toString());this.state.PushToOutputStream(p);}}break;case ControlCommand.CommandType.NoOp:break;case ControlCommand.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case ControlCommand.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case ControlCommand.CommandType.PopFunction:case ControlCommand.CommandType.PopTunnel:var q=m.commandType==ControlCommand.CommandType.PopFunction?PushPopType.Function:PushPopType.Tunnel,r=null;if(q==PushPopType.Tunnel){var s=this.state.PopEvaluationStack();if(r=s,!1==r instanceof DivertTargetValue)if(!1==s instanceof Void)throw'Expected void if ->-> doesn\'t override target';else r=null;}if(this.state.TryExitExternalFunctionEvaluation())break;else if(this.state.callStack.currentElement.type!=q||!this.state.callStack.canPop){var t={};t[PushPopType.Function]='function return statement (~ return)',t[PushPopType.Tunnel]='tunnel onwards statement (->->)';var u=t[this.state.callStack.currentElement.type];this.state.callStack.canPop||(u='end of flow (-> END or choice)');var v='Found '+t[q]+', when expected '+u;this.Error(v);}else this.state.callStack.Pop(),r&&(this.state.divertedTargetObject=this.ContentAtPath(r.targetPath));break;case ControlCommand.CommandType.BeginString:this.state.PushToOutputStream(m),this.state.inExpressionEvaluation||console.warn('Expected to be in an expression when evaluating a string'),this.state.inExpressionEvaluation=!1;break;case ControlCommand.CommandType.EndString:var w=[],x=0;for(var y=this.state.outputStream.length-1;0<=y;--y){var z=this.state.outputStream[y];x++;var A=z;if(A instanceof ControlCommand&&A.commandType==ControlCommand.CommandType.BeginString)break;z instanceof StringValue&&w.push(z);}this.state.outputStream.splice(this.state.outputStream.length-x,x),w=w.reverse();var B=new StringBuilder;w.forEach(ga=>{B.Append(ga.toString());}),this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new StringValue(B.toString()));break;case ControlCommand.CommandType.ChoiceCount:var C=this.state.generatedChoices.length;this.state.PushEvaluationStack(new IntValue(C));break;case ControlCommand.CommandType.TurnsSince:var k=this.state.PopEvaluationStack();if(!(k instanceof DivertTargetValue)){var D='';k instanceof IntValue&&(D='. Did you accidentally pass a read count (\'knot_name\') instead of a target (\'-> knot_name\')?'),this.Error('TURNS_SINCE expected a divert target (knot, stitch, label name), but saw '+k+D);break}var E=this.ContentAtPath(k.targetPath),F=this.TurnsSinceForContainer(E);this.state.PushEvaluationStack(new IntValue(F));break;case ControlCommand.CommandType.Random:var G=this.state.PopEvaluationStack(),H=this.state.PopEvaluationStack();(null==H||!1==H instanceof IntValue)&&this.Error('Invalid value for minimum parameter of RANDOM(min, max)'),(null==G||!1==H instanceof IntValue)&&this.Error('Invalid value for maximum parameter of RANDOM(min, max)');var I=G.value-H.value+1;0>=I&&this.Error('RANDOM was called with minimum as '+H.value+' and maximum as '+G.value+'. The maximum must be larger');var J=this.state.storySeed+this.state.previousRandom,K=new PRNG(J),L=K.next(),M=L%I+H.value;this.state.PushEvaluationStack(new IntValue(M)),this.state.previousRandom=L;break;case ControlCommand.CommandType.SeedRandom:var N=this.state.PopEvaluationStack();(null==N||!1==N instanceof IntValue)&&this.Error('Invalid value passed to SEED_RANDOM'),this.state.storySeed=N.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new Void);break;case ControlCommand.CommandType.VisitIndex:var O=this.VisitCountForContainer(this.state.currentContainer)-1;this.state.PushEvaluationStack(new IntValue(O));break;case ControlCommand.CommandType.SequenceShuffleIndex:var P=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new IntValue(P));break;case ControlCommand.CommandType.StartThread:break;case ControlCommand.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentContentObject=null);break;case ControlCommand.CommandType.End:this.state.ForceEnd();break;case ControlCommand.CommandType.ListFromInt:var T,Q=parseInt(this.state.PopEvaluationStack()),R=this.state.PopEvaluationStack().toString(),S=null;if(T=this.listDefinitions.TryGetDefinition(R.value,T)){var U=T.TryGetItemWithValue(Q.value);U.exists&&(S=new ListValue(U.item,Q.value));}else throw new StoryException('Failed to find LIST called '+R.value);null==S&&(S=new ListValue),this.state.PushEvaluationStack(S);break;case ControlCommand.CommandType.ListRange:var V=this.state.PopEvaluationStack(),W=this.state.PopEvaluationStack(),X=this.state.PopEvaluationStack();if(!1==X instanceof ListValue||null==X||null==W||null==V)throw new StoryException('Expected list, minimum and maximum for LIST_RANGE');function fa(ga){var ha=ga;if(ha instanceof ListValue)return parseInt(ha.value.maxItem.Value);var ia=ga;return ia instanceof IntValue?ia.value:-1}var Y=fa(W),Z=fa(V);if(-1==Y)throw new StoryException('Invalid min range bound passed to LIST_VALUE(): '+W);if(-1==Z)throw new StoryException('Invalid max range bound passed to LIST_VALUE(): '+V);var $=new ListValue,_=X.value.origins;null!=_&&_.forEach(function(ga){var ha=ga.ListRange(Y,Z);ha.value.forEach(function(ia){$.value.Add(ia.Key,ia.Value);});}),this.state.PushEvaluationStack($);break;default:this.Error('unhandled ControlCommand: '+m);}return!0}if(a instanceof VariableAssignment){var aa=this.state.PopEvaluationStack();return this.state.variablesState.Assign(a,aa),!0}if(a instanceof VariableReference){var ba=a,ca=null;if(null!=ba.pathForCount){var E=ba.containerForCount,O=this.VisitCountForContainer(E);ca=new IntValue(O);}else ca=this.state.variablesState.GetVariableWithName(ba.name),null==ca&&(this.Error('Uninitialised variable: '+ba.name),ca=new IntValue(0));return this.state.PushEvaluationStack(ca),!0}if(a instanceof NativeFunctionCall){var da=a,ea=this.state.PopEvaluationStack(da.numberOfParameters),$=da.Call(ea);return this.state.PushEvaluationStack($),!0}return!1}ChoosePathString(a){this.ChoosePath(new Path$1(a));}ChoosePath(a){this.state.SetChosenPath(a),this.VisitChangedContainersDueToDivert();}ChooseChoiceIndex(a){a=a;var b=this.currentChoices;(0>a||a>b.length)&&console.warn('choice out of range');var d=b[a];this.state.callStack.currentThread=d.threadAtGeneration,this.ChoosePath(d.choicePoint.choiceTarget.path);}HasFunction(a){try{return this.ContentAtPath(new Path$1(a))instanceof Container}catch(b){return!1}}EvaluateFunction(a,b,d){if(d=!!d,null==a)throw'Function is null';else if(''==a||''==a.trim())throw'Function is empty or white space.';var f=null;try{f=this.ContentAtPath(new Path$1(a));}catch(k){if(0<=k.message.indexOf('not found'))throw'Function doesn\'t exist: \''+a+'\'';else throw k}this.state.StartExternalFunctionEvaluation(f,b);for(var g=new StringBuilder;this.canContinue;)g.Append(this.Continue());var h=g.toString(),j=this.state.CompleteExternalFunctionEvaluation();return d?{returned:j,output:h}:j}EvaluateExpression(a){var b=this.state.callStack.elements.length;this.state.callStack.Push(PushPopType.Tunnel),this._temporaryEvaluationContainer=a,this.state.GoToStart();var d=this.state.evaluationStack.length;this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>b&&this.state.callStack.Pop();var f=this.state.evaluationStack.length;return f>d?this.state.PopEvaluationStack():null}CallExternalFunction(a,b){var d=this._externals[a],f=null;if('undefined'==typeof d){if(this.allowExternalFunctionFallbacks)return f=this.ContentAtPath(new Path$1(a)),f instanceof Container||console.warn('Trying to call EXTERNAL function \''+a+'\' which has not been bound, and fallback ink function could not be found.'),this.state.callStack.Push(PushPopType.Function),void(this.state.divertedTargetObject=f);console.warn('Trying to call EXTERNAL function \''+a+'\' which has not been bound (and ink fallbacks disabled).');}var g=[];for(var h=0;h<b;++h){var j=this.state.PopEvaluationStack(),k=j.valueObject;g.push(k);}g.reverse();var m=d(g),n=null;null==m?n=new Void:(n=Value.Create(m),null==n&&console.warn('Could not create ink value from returned object of type '+typeof m)),this.state.PushEvaluationStack(n);}TryCoerce(a){return a}BindExternalFunctionGeneral(a,b){this._externals[a]&&console.warn('Function \''+a+'\' has already been bound.'),this._externals[a]=b;}BindExternalFunction(a,b){b||console.warn('Can\'t bind a null function'),this.BindExternalFunctionGeneral(a,d=>{d.length<b.length&&console.warn('External function expected '+b.length+' arguments');var f=[];for(var g=0,h=d.length;g<h;g++)f[g]=this.TryCoerce(d[g]);return b.apply(null,f)});}UnbindExternalFunction(a){'undefined'==typeof this._externals[a]&&console.warn('Function \''+a+'\' has not been bound.'),delete this._externals[a];}ValidateExternalBindings(a,b){if(!a){var b=[];if(this.ValidateExternalBindings(this._mainContentContainer,b),this._hasValidatedExternals=!0,0==b.length)this._hasValidatedExternals=!0;else{var d='Error: Missing function binding for external';d+=1<b.length?'s':'',d+=': \'',d+=b.join('\', \''),d+='\' ',d+=this.allowExternalFunctionFallbacks?', and no fallback ink function found.':' (ink fallbacks disabled)',this.Error(d);}}else if(a instanceof Container){var f=a;for(var g in f.content.forEach(m=>{this.ValidateExternalBindings(m,b);}),f.namedContent)this.ValidateExternalBindings(f.namedContent[g],b);}else{var h=a;if(h instanceof Divert&&h.isExternal){var j=h.targetPathString;if(!this._externals[j])if(this.allowExternalFunctionFallbacks){var k=!!this.mainContentContainer.namedContent[j];k||b.push(j);}else b.push(j);}}}ObserveVariable(a,b){null==this._variableObservers&&(this._variableObservers={}),this._variableObservers[a]?this._variableObservers[a].push(b):this._variableObservers[a]=[b];}ObserveVariables(a,b){for(var d=0,f=a.length;d<f;d++)this.ObserveVariable(a[d],b[d]);}RemoveVariableObserver(a,b){if(null!=this._variableObservers)if('undefined'!=typeof b)this._variableObservers[b]&&this._variableObservers[b].splice(this._variableObservers[b].indexOf(a),1);else for(var d in this._variableObservers)this._variableObservers[d].splice(this._variableObservers[d].indexOf(a),1);}VariableStateDidChangeEvent(a,b){if(null!=this._variableObservers){var d=this._variableObservers[a];if('undefined'!=typeof d){if(!(b instanceof Value))throw'Tried to get the value of a variable that isn\'t a standard type';d.forEach(function(f){f(a,b.valueObject);});}}}TagsForContentAtPath(a){return this.TagsAtStartOfFlowContainerWithPathString(a)}TagsAtStartOfFlowContainerWithPathString(a){for(var b=new Path$1(a),d=this.ContentAtPath(b);!0;){var f=d.content[0];if(f instanceof Container)d=f;else break}var g=null;return d.content.every(h=>{var j=h;return!!(j instanceof Tag)&&(null==g&&(g=[]),g.push(j.text),!0)}),g}BuildStringOfHierarchy(){var a=new StringBuilder;return this.mainContentContainer.BuildStringOfHierarchy(a,0,this.state.currentContentObject),a.toString()}NextContent(){if(this.state.previousContentObject=this.state.currentContentObject,!(null!=this.state.divertedTargetObject&&(this.state.currentContentObject=this.state.divertedTargetObject,this.state.divertedTargetObject=null,this.VisitChangedContainersDueToDivert(),null!=this.state.currentContentObject))){var a=this.IncrementContentPointer();if(!a){var b=!1;this.state.callStack.CanPop(PushPopType.Function)?(this.state.callStack.Pop(PushPopType.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new Void),b=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),b=!0):this.state.TryExitExternalFunctionEvaluation(),b&&null!=this.state.currentContentObject&&this.NextContent();}}}IncrementContentPointer(){var a=!0,b=this.state.callStack.currentElement;for(b.currentContentIndex++;b.currentContentIndex>=b.currentContainer.content.length;){a=!1;var d=b.currentContainer.parent;if(!1==d instanceof Container)break;var f=d.content.indexOf(b.currentContainer);if(-1==f)break;b.currentContainer=d,b.currentContentIndex=f+1,a=!0;}return a||(b.currentContainer=null),a}TryFollowDefaultInvisibleChoice(){var a=this._state.currentChoices,b=a.filter(f=>{return f.choicePoint.isInvisibleDefault});if(0==b.length||a.length>b.length)return!1;var d=b[0];return this.ChoosePath(d.choicePoint.choiceTarget.path),!0}VisitCountForContainer(a){if(!a.visitsShouldBeCounted)return console.warn('Read count for target ('+a.name+' - on '+a.debugMetadata+') unknown. The story may need to be compiled with countAllVisits flag (-c).'),0;var b=0,d=a.path.toString();return b=this.state.visitCounts[d]||b,b}IncrementVisitCountForContainer(a){var b=0,d=a.path.toString();this.state.visitCounts[d]&&(b=this.state.visitCounts[d]),b++,this.state.visitCounts[d]=b;}RecordTurnIndexVisitToContainer(a){var b=a.path.toString();this.state.turnIndices[b]=this.state.currentTurnIndex;}TurnsSinceForContainer(a){a.turnIndexShouldBeCounted||this.Error('TURNS_SINCE() for target ('+a.name+' - on '+a.debugMetadata+') unknown. The story may need to be compiled with countAllVisits flag (-c).');var b=a.path.toString(),d=this.state.turnIndices[b];return'undefined'==typeof d?-1:this.state.currentTurnIndex-d}NextSequenceShuffleIndex(){var a=this.state.PopEvaluationStack();if(!(a instanceof IntValue))return this.Error('expected number of elements in sequence for shuffle index'),0;var b=this.state.currentContainer,d=a.value,f=this.state.PopEvaluationStack(),g=f.value,h=g%d,j=b.path.toString(),k=0;for(var m=0,n=j.length;m<n;m++)k+=j.charCodeAt[m]||0;var p=k+g/d+this.state.storySeed,q=new PRNG(parseInt(p)),r=[];for(var m=0;m<d;++m)r.push(m);for(var m=0;m<=h;++m){var s=q.next()%r.length,t=r[s];if(r.splice(s,1),m==h)return t}throw'Should never reach here'}Error(a){var b=new StoryException(a);throw b}AddError(a,b){var d=null;a='RUNTIME ERROR: '+a;var f;this.state.AddError(a),this.state.ForceEnd();}}

	exports.Story = Story;

	Object.defineProperty(exports, '__esModule', { value: true });

})));
